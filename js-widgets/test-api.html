<!DOCTYPE html>
<html>
<head>
    <title>API Test Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .test-form {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .info {
            background: #e2e3f0;
            border: 1px solid #b8bcc8;
            color: #383d41;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div class="test-container">
    <h1>üß™ API Test Tool</h1>
    
    <div class="info">
        <strong>Purpose:</strong> Test your WordPress API endpoint for seat counting.<br>
        <strong>Current URL:</strong> <span id="current-url">Not set</span><br>
        <strong>Instructions:</strong> Enter your WordPress site URL below and test the API.
    </div>
    
    <div class="test-form">
        <div class="form-group">
            <label for="api-url">WordPress Site URL:</label>
            <input type="text" id="api-url" placeholder="https://cuadroacademy.com" value="https://cuadroacademy.com">
        </div>
        
        <div class="form-group">
            <label for="seat-limit">Seat Limit Override:</label>
            <input type="number" id="seat-limit" placeholder="300" value="300">
        </div>
        
        <button onclick="testAPI()">üöÄ Test API Endpoint</button>
        <button onclick="testCORS()" style="margin-left: 10px;">üåê Test CORS</button>
    </div>
    
    <div id="result" class="result" style="display: none;"></div>
</div>

<script>
function updateCurrentURL() {
    const url = document.getElementById('api-url').value;
    const limit = document.getElementById('seat-limit').value;
    const fullURL = `${url}/wp-json/llm/v1/seats-remaining?limit=${limit}`;
    document.getElementById('current-url').textContent = fullURL;
}

function showResult(content, isSuccess = true) {
    const resultDiv = document.getElementById('result');
    resultDiv.style.display = 'block';
    resultDiv.className = 'result ' + (isSuccess ? 'success' : 'error');
    resultDiv.textContent = content;
}

async function testAPI() {
    const url = document.getElementById('api-url').value.replace(/\/$/, ''); // Remove trailing slash
    const limit = document.getElementById('seat-limit').value || '300';
    const fullURL = `${url}/wp-json/llm/v1/seats-remaining?limit=${limit}`;
    
    showResult('Testing API endpoint...\nURL: ' + fullURL + '\n\nPlease wait...', true);
    
    try {
        const response = await fetch(fullURL, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        const result = `‚úÖ SUCCESS! API is working correctly.

Response Data:
${JSON.stringify(data, null, 2)}

Status Information:
- Total Limit: ${data.total_limit}
- Current Count: ${data.current_count}
- Remaining: ${data.remaining}
- Percentage Filled: ${data.percentage_filled}%
- Status: ${data.status}
- Last Updated: ${data.last_updated}

CORS Headers:
- Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin') || 'Not set'}

‚úÖ Ready to use in Go High Level!`;
        
        showResult(result, true);
        
    } catch (error) {
        const result = `‚ùå ERROR: API test failed

Error Details:
${error.message}

Possible Issues:
1. WordPress site is not accessible
2. Plugin not activated or API endpoint not registered
3. CORS policy blocking the request
4. Invalid URL format

Troubleshooting:
1. Check if this URL works in your browser: ${fullURL}
2. Make sure the plugin is activated
3. Check WordPress error logs
4. Verify the URL is correct (no trailing slashes)

If the URL works in your browser but fails here, it's likely a CORS issue.`;
        
        showResult(result, false);
    }
}

async function testCORS() {
    const url = document.getElementById('api-url').value.replace(/\/$/, '');
    const fullURL = `${url}/wp-json/llm/v1/seats-remaining?limit=300`;
    
    showResult('Testing CORS configuration...\n\nSending OPTIONS preflight request...', true);
    
    try {
        // Test OPTIONS request (preflight)
        const optionsResponse = await fetch(fullURL, {
            method: 'OPTIONS',
            headers: {
                'Origin': window.location.origin,
                'Access-Control-Request-Method': 'GET',
                'Access-Control-Request-Headers': 'Content-Type',
            },
        });
        
        const corsHeaders = {
            'Access-Control-Allow-Origin': optionsResponse.headers.get('Access-Control-Allow-Origin'),
            'Access-Control-Allow-Methods': optionsResponse.headers.get('Access-Control-Allow-Methods'),
            'Access-Control-Allow-Headers': optionsResponse.headers.get('Access-Control-Allow-Headers'),
            'Access-Control-Max-Age': optionsResponse.headers.get('Access-Control-Max-Age'),
        };
        
        let result = `üåê CORS Test Results:

OPTIONS Request Status: ${optionsResponse.status} ${optionsResponse.statusText}

CORS Headers Received:`;
        
        for (const [header, value] of Object.entries(corsHeaders)) {
            result += `\n- ${header}: ${value || 'Not set'}`;
        }
        
        if (corsHeaders['Access-Control-Allow-Origin'] === '*' || 
            corsHeaders['Access-Control-Allow-Origin'] === window.location.origin) {
            result += '\n\n‚úÖ CORS configuration looks good!';
            showResult(result, true);
        } else {
            result += '\n\n‚ùå CORS configuration may have issues.';
            result += '\n\nExpected: Access-Control-Allow-Origin: *';
            result += `\nActual: ${corsHeaders['Access-Control-Allow-Origin']}`;
            showResult(result, false);
        }
        
    } catch (error) {
        const result = `‚ùå CORS Test Failed:

Error: ${error.message}

This usually indicates:
1. The server doesn't support OPTIONS requests
2. The endpoint is not configured for CORS
3. Network/connectivity issues

Try running the regular API test first.`;
        
        showResult(result, false);
    }
}

// Update URL display when inputs change
document.getElementById('api-url').addEventListener('input', updateCurrentURL);
document.getElementById('seat-limit').addEventListener('input', updateCurrentURL);

// Initialize
updateCurrentURL();
</script>

</body>
</html>